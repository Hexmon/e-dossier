#!/usr/bin/env bash
# .githooks/pre-push
# Enterprise-grade pre-push hook for lint, typecheck, and build verification
# Works on Windows (PowerShell), Windows (Git Bash), macOS, and Linux
# Usage: Automatically triggered by `git push`
# Auto-setup: If core.hooksPath is not configured, sets it up automatically
# Platform detection: Delegates to .ps1 on native Windows, runs natively on Unix

# Detect if running on Windows native PowerShell (not Git Bash)
if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "win32" ]] && command -v pwsh &>/dev/null; then
  # On Windows with PowerShell available, delegate to PowerShell wrapper
  exec pwsh -File "$(git rev-parse --show-toplevel)/.githooks/pre-push.ps1"
fi

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ensure we run from the repository root
REPO_ROOT="$(git rev-parse --show-toplevel)" || exit 1
cd "$REPO_ROOT" || exit 1

# Auto-setup: Configure core.hooksPath if not already set
CURRENT_HOOKS_PATH=$(git config core.hooksPath || echo "")
if [ "$CURRENT_HOOKS_PATH" != ".githooks" ]; then
  git config core.hooksPath .githooks
  chmod +x .githooks/pre-push 2>/dev/null || true
  chmod +x .githooks/post-checkout 2>/dev/null || true
fi

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ” Pre-Push Quality Checks${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Preflight checks
echo -e "${YELLOW}[Preflight Checks]${NC}"

# Check 1: pnpm-lock.yaml exists
if [ ! -f pnpm-lock.yaml ]; then
  echo -e "${RED}âŒ FAILED: pnpm-lock.yaml not found${NC}"
  echo "   Please run 'pnpm install' to generate the lock file."
  exit 1
fi
echo -e "${GREEN}âœ“${NC} pnpm-lock.yaml exists"

# Check 2: pnpm is available
if ! command -v pnpm &> /dev/null; then
  echo -e "${RED}âŒ FAILED: pnpm not found on PATH${NC}"
  echo "   Please install pnpm: https://pnpm.io/installation"
  exit 1
fi
echo -e "${GREEN}âœ“${NC} pnpm is available"

# Check 3: Node version >= 20
NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt 20 ]; then
  echo -e "${RED}âŒ FAILED: Node.js version is too old${NC}"
  echo "   Required: Node.js >= 20"
  echo "   Found: $(node -v)"
  echo "   Please upgrade Node.js: https://nodejs.org/"
  exit 1
fi
echo -e "${GREEN}âœ“${NC} Node.js version $(node -v) (required: >=20)"

# Check 4: pnpm version >= 9
PNPM_VERSION=$(pnpm -v | cut -d'.' -f1)
if [ "$PNPM_VERSION" -lt 9 ]; then
  echo -e "${RED}âŒ FAILED: pnpm version is too old${NC}"
  echo "   Required: pnpm >= 9"
  echo "   Found: $(pnpm -v)"
  echo "   Please upgrade pnpm: pnpm add -g pnpm@latest"
  exit 1
fi
echo -e "${GREEN}âœ“${NC} pnpm version $(pnpm -v) (required: >=9)"

echo ""
echo -e "${YELLOW}[Preparing Fresh Build]${NC}"

# Remove prior Next.js build output so build always runs from a clean state
if [ -d .next ]; then
  rm -rf .next
  echo -e "${GREEN}âœ“${NC} Removed existing .next directory"
else
  echo -e "${GREEN}âœ“${NC} No existing .next directory to remove"
fi

echo ""
echo -e "${YELLOW}[Running Quality Checks]${NC}"

if ! pnpm run lint; then
  echo ""
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${RED}âŒ LINT FAILED - Push Blocked${NC}"
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo "Fix lint errors and try again: pnpm run lint"
  echo "To bypass this check (not recommended): git push --no-verify"
  exit 1
fi

if ! pnpm run build; then
  echo ""
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${RED}âŒ BUILD FAILED - Push Blocked${NC}"
  echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo "Fix build errors and try again: pnpm run build"
  echo "To bypass this check (not recommended): git push --no-verify"
  exit 1
fi

echo ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… All Checks Passed - Push Allowed${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
exit 0
